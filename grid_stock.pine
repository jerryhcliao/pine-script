//@version=6
// =============== ç­–ç•¥è®¾ç½® ===============
strategy("ç½‘æ ¼äº¤æ˜“ç­–ç•¥ - Aè‚¡ (æ”¹è¿›ç‰ˆ)", 
     overlay=true, 
     precision=2, 
     initial_capital=200000, 
     pyramiding=40, 
     default_qty_type = strategy.fixed,
     margin_long=100,
     margin_short=100,
     process_orders_on_close=false)

// =============== å¤šç©ºäº¤æ˜“çº¦æŸ ===============
// ä»…å…è®¸åšå¤š
strategy.risk.allow_entry_in(strategy.direction.long)

// =============== ç½‘æ ¼ç­–ç•¥å‚æ•° - æ™®é€šè‚¡ç¥¨ ===============
INITIAL_POSITION_AMOUNT_NORMAL = 60000.0            // åˆå§‹å»ºä»“é‡‘é¢(å…ƒ)
EARLY_GRID_DROP_PERCENT_NORMAL = 0.05               // æ™®é€šè‚¡ç¥¨å‰5ä¸ªç½‘æ ¼ä¸‹è·Œç™¾åˆ†æ¯”(%)
EARLY_TAKE_PROFIT_PERCENT_NORMAL = 0.10             // æ™®é€šè‚¡ç¥¨å‰5ä¸ªç½‘æ ¼æ­¢ç›ˆç™¾åˆ†æ¯”(%)
LATE_GRID_DROP_PERCENT_NORMAL = 0.10                // æ™®é€šè‚¡ç¥¨è¶…è¿‡5ä¸ªç½‘æ ¼åä¸‹è·Œç™¾åˆ†æ¯”(%)
LATE_TAKE_PROFIT_PERCENT_NORMAL = 0.15              // æ™®é€šè‚¡ç¥¨è¶…è¿‡5ä¸ªç½‘æ ¼åæ­¢ç›ˆç™¾åˆ†æ¯”(%)
EARLY_GRID_INCREASE_PERCENT_NORMAL = 0.10           // æ™®é€šè‚¡ç¥¨å‰5ä¸ªç½‘æ ¼åŠ ä»“æ¯”ä¾‹(%)
LATE_GRID_INCREASE_PERCENT_NORMAL = 0.15            // æ™®é€šè‚¡ç¥¨è¶…è¿‡5ä¸ªç½‘æ ¼ååŠ ä»“æ¯”ä¾‹(%)
BEAR_MARKET_INCREASE_PERCENT_NORMAL = 0.20          // æ™®é€šè‚¡ç¥¨è¶…è¿‡5ä¸ªç½‘æ ¼åï¼Œç†Šå¸‚åŠ ä»“æ¯”ä¾‹(%)

// =============== ç½‘æ ¼ç­–ç•¥å‚æ•° - ç§‘åˆ›æ¿ ===============
INITIAL_POSITION_AMOUNT_SCI = 60000.0               // åˆå§‹å»ºä»“é‡‘é¢(å…ƒ)
EARLY_GRID_DROP_PERCENT_SCI = 0.08                  // ç§‘åˆ›æ¿å‰5ä¸ªç½‘æ ¼ä¸‹è·Œç™¾åˆ†æ¯”(%)
EARLY_TAKE_PROFIT_PERCENT_SCI = 0.16                // ç§‘åˆ›æ¿å‰5ä¸ªç½‘æ ¼æ­¢ç›ˆç™¾åˆ†æ¯”(%)
LATE_GRID_DROP_PERCENT_SCI = 0.14                   // ç§‘åˆ›æ¿è¶…è¿‡5ä¸ªç½‘æ ¼åä¸‹è·Œç™¾åˆ†æ¯”(%)
LATE_TAKE_PROFIT_PERCENT_SCI = 0.28                 // ç§‘åˆ›æ¿è¶…è¿‡5ä¸ªç½‘æ ¼åæ­¢ç›ˆç™¾åˆ†æ¯”(%)
EARLY_GRID_INCREASE_PERCENT_SCI = 0.10              // ç§‘åˆ›æ¿å‰5ä¸ªç½‘æ ¼åŠ ä»“æ¯”ä¾‹(%)
LATE_GRID_INCREASE_PERCENT_SCI = 0.15               // ç§‘åˆ›æ¿è¶…è¿‡5ä¸ªç½‘æ ¼ååŠ ä»“æ¯”ä¾‹(%)
BEAR_MARKET_INCREASE_PERCENT_SCI = 0.20             // ç§‘åˆ›æ¿è¶…è¿‡5ä¸ªç½‘æ ¼åï¼Œç†Šå¸‚åŠ ä»“æ¯”ä¾‹(%)

// =============== ç½‘æ ¼ç­–ç•¥å‚æ•° - æŒ‡æ•°åŸºé‡‘(ETF) ===============
INITIAL_POSITION_AMOUNT_ETF = 100000.0              // åˆå§‹å»ºä»“é‡‘é¢(å…ƒ)
EARLY_GRID_DROP_PERCENT_ETF = 0.05                  // æŒ‡æ•°åŸºé‡‘å‰5ä¸ªç½‘æ ¼ä¸‹è·Œç™¾åˆ†æ¯”(%)
EARLY_TAKE_PROFIT_PERCENT_ETF = 0.10                // æŒ‡æ•°åŸºé‡‘å‰5ä¸ªç½‘æ ¼æ­¢ç›ˆç™¾åˆ†æ¯”(%)
LATE_GRID_DROP_PERCENT_ETF = 0.10                   // æŒ‡æ•°åŸºé‡‘è¶…è¿‡5ä¸ªç½‘æ ¼åä¸‹è·Œç™¾åˆ†æ¯”(%)
LATE_TAKE_PROFIT_PERCENT_ETF = 0.15                 // æŒ‡æ•°åŸºé‡‘è¶…è¿‡5ä¸ªç½‘æ ¼åæ­¢ç›ˆç™¾åˆ†æ¯”(%)
EARLY_GRID_INCREASE_PERCENT_ETF = 0.10              // æŒ‡æ•°åŸºé‡‘å‰5ä¸ªç½‘æ ¼åŠ ä»“æ¯”ä¾‹(%)
LATE_GRID_INCREASE_PERCENT_ETF = 0.15               // æŒ‡æ•°åŸºé‡‘è¶…è¿‡5ä¸ªç½‘æ ¼ååŠ ä»“æ¯”ä¾‹(%)
BEAR_MARKET_INCREASE_PERCENT_ETF = 0.20             // æŒ‡æ•°åŸºé‡‘è¶…è¿‡5ä¸ªç½‘æ ¼åï¼Œç†Šå¸‚åŠ ä»“æ¯”ä¾‹(%)

// =============== é€šç”¨å‚æ•° ===============
MAX_GRIDS = 40                                      // æœ€å¤§ç½‘æ ¼å±‚æ•°
COOLDOWN_PERIOD = 4                                 // æ¸…ä»“åå†·å´Kçº¿æ•°
REENTRY_DISCOUNT = 0.03                             // æå‰é‡å…¥å›è°ƒå¹…åº¦(%)
// è‚¡ç¥¨å›æµ‹æ—¶é—´é™åˆ¶ (è‡ª2020å¹´1æœˆ1æ—¥)
START_DATE_MS = timestamp("2020/01/01")

// =============== è°ƒè¯•æ¨¡å¼å‚æ•° ===============
DEBUG_MODE = input.bool(false, "DEBUGæ¨¡å¼", group="è°ƒè¯•è®¾ç½®", tooltip="å¼€å¯åæ˜¾ç¤ºè¯¦ç»†çš„ç½‘æ ¼ä¿¡æ¯è¡¨æ ¼")

in_trading_timeframe = time > START_DATE_MS


// --- Kçº¿æ—¶é—´ï¼Œæ–¹ä¾¿è°ƒè¯• ---
// è·å–å„ä¸ªæ—¶é—´ç»„ä»¶
yr = year(time)
mo = month(time)
dy = dayofmonth(time)
hr = hour(time)
min = minute(time)
sec = second(time)

// è½¬æ¢æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ä¸ºä¸¤ä½æ•°æ ¼å¼
mo_str = mo < 10 ? "0" + str.tostring(mo) : str.tostring(mo)
dy_str = dy < 10 ? "0" + str.tostring(dy) : str.tostring(dy)
hr_str = hr < 10 ? "0" + str.tostring(hr) : str.tostring(hr)
min_str = min < 10 ? "0" + str.tostring(min) : str.tostring(min)

// ç»„åˆæˆæœ€ç»ˆæ ¼å¼
k_formatted_time = str.tostring(yr) + mo_str + dy_str + hr_str + min_str

// =============== ç½‘æ ¼äº¤æ˜“çŠ¶æ€å˜é‡ ===============
// ç”¨æ•°ç»„è®°å½•æ¯æ‰¹æ¬¡çš„ä¹°å…¥ä»·æ ¼ã€æ•°é‡å’ŒID
// æ³¨æ„ï¼šç½‘æ ¼ä»1å¼€å§‹ç¼–å·ï¼Œæ•°ç»„ç´¢å¼• = ç½‘æ ¼ç¼–å·
// ä¾‹å¦‚ï¼šç½‘æ ¼1å­˜å‚¨åœ¨æ•°ç»„ç´¢å¼•1ï¼Œç½‘æ ¼2å­˜å‚¨åœ¨æ•°ç»„ç´¢å¼•2ï¼Œä»¥æ­¤ç±»æ¨
var float[] entry_prices = array.new_float(MAX_GRIDS + 1, 0.0)
var float[] entry_quantities = array.new_float(MAX_GRIDS + 1, 0.0)
var string[] entry_ids = array.new_string(MAX_GRIDS + 1, "")
// è®°å½•æœ€åä¸€æ¬¡ä¹°å…¥ä»·æ ¼ï¼ˆç”¨äºè®¡ç®—ä¸‹ä¸€ä¸ªç½‘æ ¼ï¼‰
var float current_entry_price = 0.0
// è®°å½•ä¸‹ä¸€ä¸ªç½‘æ ¼ä¹°å…¥ä»·æ ¼
var float next_grid_price = 0.0
// è®°å½•å½“å‰ç½‘æ ¼æ­¢ç›ˆä»·æ ¼
var float current_grid_profit_price = 0.0
// è®°å½•å½“å‰è¢«å ç”¨çš„ç½‘æ ¼æ•°é‡ï¼ˆç½‘æ ¼ä»1å¼€å§‹ç¼–å·ï¼‰
var int current_slot = 0
// è®°å½•ä¸‹ä¸€ä¸ªç©ºé—²çš„ç½‘æ ¼ä½ç½®ï¼ˆç½‘æ ¼ä»1å¼€å§‹ç¼–å·ï¼‰
var int next_slot = 1
// æ—¶é—´å†·å´æœºåˆ¶
var int cooldown_bars = 0
// æœ€åæ¸…ä»“ä»·æ ¼
var float last_exit_price = 0.0
// æœ€å¤§èµ„é‡‘å ç”¨è®°å½•
var float max_capital_used = 0.0
// å½“å‰èµ„é‡‘å ç”¨
var float current_capital_used = 0.0
// ç´¯è®¡ç›ˆåˆ©é‡‘é¢
var float cumulative_profit = 0.0
// æ˜¯å¦ç ´äº§ï¼ˆè§¦å‘åŠ ä»“æ¡ä»¶ä½†èµ„é‡‘ä¸è¶³ï¼‰
var bool is_bankrupt = false
// ç ´äº§æ—¥æœŸ
var string bankrupt_date = ""

// =============== è¿è¡Œæ—¶ç½‘æ ¼å‚æ•°ï¼ˆæ ¹æ®è‚¡ç¥¨ç±»å‹åˆå§‹åŒ–ä¸€æ¬¡ï¼‰===============
// æ£€æµ‹æ˜¯å¦ä¸ºç§‘åˆ›æ¿è‚¡ç¥¨ï¼ˆä»£ç ä»¥688å¼€å¤´ï¼‰
is_sci_board = str.startswith(syminfo.ticker, "688")
// æ£€æµ‹æ˜¯å¦ä¸ºæŒ‡æ•°åŸºé‡‘(ETF)
etf_tickers = array.from("159632", "159915")
is_etf = array.includes(etf_tickers, syminfo.ticker)

// æ ¹æ®è‚¡ç¥¨ç±»å‹åˆå§‹åŒ–ç½‘æ ¼å‚æ•°ï¼ˆåªåœ¨ç¬¬ä¸€æ ¹Kçº¿åˆå§‹åŒ–ä¸€æ¬¡ï¼‰
var float INITIAL_POSITION_AMOUNT = 0.0
var float EARLY_GRID_DROP_PERCENT = 0.0
var float EARLY_TAKE_PROFIT_PERCENT = 0.0
var float LATE_GRID_DROP_PERCENT = 0.0
var float LATE_TAKE_PROFIT_PERCENT = 0.0
var float EARLY_GRID_INCREASE_PERCENT = 0.0
var float LATE_GRID_INCREASE_PERCENT = 0.0
var float BEAR_MARKET_INCREASE_PERCENT = 0.0
var int MIN_SHARES = 0

// åªåœ¨ç¬¬ä¸€æ ¹Kçº¿æ—¶åˆå§‹åŒ–å‚æ•°
if barstate.isfirst
    // æ ¹æ®è‚¡ç¥¨ç±»å‹é€‰æ‹©å‚æ•°ï¼šä¼˜å…ˆçº§ æŒ‡æ•°åŸºé‡‘(ETF) > ç§‘åˆ›æ¿ > æ™®é€šè‚¡ç¥¨
    if is_etf
        // æŒ‡æ•°åŸºé‡‘(ETF)å‚æ•°
        INITIAL_POSITION_AMOUNT := INITIAL_POSITION_AMOUNT_ETF
        EARLY_GRID_DROP_PERCENT := EARLY_GRID_DROP_PERCENT_ETF
        EARLY_TAKE_PROFIT_PERCENT := EARLY_TAKE_PROFIT_PERCENT_ETF
        LATE_GRID_DROP_PERCENT := LATE_GRID_DROP_PERCENT_ETF
        LATE_TAKE_PROFIT_PERCENT := LATE_TAKE_PROFIT_PERCENT_ETF
        EARLY_GRID_INCREASE_PERCENT := EARLY_GRID_INCREASE_PERCENT_ETF
        LATE_GRID_INCREASE_PERCENT := LATE_GRID_INCREASE_PERCENT_ETF
        BEAR_MARKET_INCREASE_PERCENT := BEAR_MARKET_INCREASE_PERCENT_ETF
        MIN_SHARES := 100
    else if is_sci_board
        // ç§‘åˆ›æ¿å‚æ•°
        INITIAL_POSITION_AMOUNT := INITIAL_POSITION_AMOUNT_SCI
        EARLY_GRID_DROP_PERCENT := EARLY_GRID_DROP_PERCENT_SCI
        EARLY_TAKE_PROFIT_PERCENT := EARLY_TAKE_PROFIT_PERCENT_SCI
        LATE_GRID_DROP_PERCENT := LATE_GRID_DROP_PERCENT_SCI
        LATE_TAKE_PROFIT_PERCENT := LATE_TAKE_PROFIT_PERCENT_SCI
        EARLY_GRID_INCREASE_PERCENT := EARLY_GRID_INCREASE_PERCENT_SCI
        LATE_GRID_INCREASE_PERCENT := LATE_GRID_INCREASE_PERCENT_SCI
        BEAR_MARKET_INCREASE_PERCENT := BEAR_MARKET_INCREASE_PERCENT_SCI
        MIN_SHARES := 200
    else
        // æ™®é€šè‚¡ç¥¨å‚æ•°
        INITIAL_POSITION_AMOUNT := INITIAL_POSITION_AMOUNT_NORMAL
        EARLY_GRID_DROP_PERCENT := EARLY_GRID_DROP_PERCENT_NORMAL
        EARLY_TAKE_PROFIT_PERCENT := EARLY_TAKE_PROFIT_PERCENT_NORMAL
        LATE_GRID_DROP_PERCENT := LATE_GRID_DROP_PERCENT_NORMAL
        LATE_TAKE_PROFIT_PERCENT := LATE_TAKE_PROFIT_PERCENT_NORMAL
        EARLY_GRID_INCREASE_PERCENT := EARLY_GRID_INCREASE_PERCENT_NORMAL
        LATE_GRID_INCREASE_PERCENT := LATE_GRID_INCREASE_PERCENT_NORMAL
        BEAR_MARKET_INCREASE_PERCENT := BEAR_MARKET_INCREASE_PERCENT_NORMAL
        MIN_SHARES := 100

// è®¡ç®—å½“å‰å¯ç”¨ç°é‡‘ï¼ˆä½¿ç”¨ç­–ç•¥å†…ç½®æƒç›Šå˜é‡ï¼‰
get_available_cash() =>
    // å¯ç”¨ç°é‡‘ = æ€»æƒç›Š - æŒä»“å¸‚å€¼
    strategy.equity - strategy.position_size * close

// =============== å‡çº¿ç³»ç»Ÿè®¡ç®— ===============
// è®¡ç®—4æ ¹å‡çº¿
ma1 = ta.sma(close, 25 * 4)  // æœˆçº¿
ma2 = ta.sma(close, 75 * 4)  // å­£çº¿
ma3 = ta.sma(close, 125 * 4) // åŠå¹´çº¿
ma4 = ta.sma(close, 250 * 4) // å¹´çº¿

// åˆ¤æ–­å¸‚åœºè¶‹åŠ¿
is_bull_market = ma1 > ma2 and ma2 > ma3 and ma3 > ma4
is_bear_market = ma1 < ma2 and ma2 < ma3 and ma3 < ma4

// è®¡ç®—ä¸‹ä¸€ä¸ªç½‘æ ¼ä¹°å…¥ç‚¹ï¼ˆæ ¹æ®å½“å‰ç½‘æ ¼å±‚æ•°ä½¿ç”¨ä¸åŒå‚æ•°ï¼‰
calculate_next_grid_price(last_price, current_slot) =>
    drop_percent = current_slot <= 5 ? EARLY_GRID_DROP_PERCENT : LATE_GRID_DROP_PERCENT
    last_price * (1 - drop_percent)

// è®¡ç®—æ­¢ç›ˆä»·æ ¼ï¼ˆæ ¹æ®å½“å‰ç½‘æ ¼å±‚æ•°ä½¿ç”¨ä¸åŒå‚æ•°ï¼‰
calculate_take_profit_price(entry_price, current_slot) =>
    profit_percent = current_slot <= 5 ? EARLY_TAKE_PROFIT_PERCENT : LATE_TAKE_PROFIT_PERCENT
    entry_price * (1 + profit_percent)

// è®¡ç®—å¯ä»¥ä¹°å…¥çš„è‚¡æ•°ï¼ˆå¿…é¡»æ˜¯100çš„æ•´æ•°å€ï¼‰
// å¦‚æœæ¡ä»¶ä¸å…è®¸ï¼ˆè‚¡æ•°ä¸è¶³æœ€å°è‚¡æ•°æˆ–èµ„é‡‘ä¸è¶³ï¼‰ï¼Œç›´æ¥è¿”å›0
calculate_initial_shares(amount, price) =>
    shares = math.floor(amount / price / 100) * 100
    available_cash = get_available_cash()
    if shares >= MIN_SHARES and available_cash >= shares * price
        shares
    else
        0

// è®¡ç®—åŠ ä»“æ•°é‡ï¼ˆæ ¹æ®å½“å‰ç½‘æ ¼å±‚æ•°å’Œå¸‚åœºçŠ¶æ€ä½¿ç”¨ä¸åŒåŠ ä»“ç­–ç•¥ï¼‰
// å¦‚æœèµ„é‡‘ä¸è¶³ï¼Œç›´æ¥è¿”å›0
calculate_additional_shares(current_position_size, current_slot) =>
    increase_percent = 0.10
    additional_shares = 0

    if current_slot <= 5
        // å‰5ä¸ªç½‘æ ¼ï¼šä½¿ç”¨æ—©æœŸåŠ ä»“æ¯”ä¾‹
        increase_percent := EARLY_GRID_INCREASE_PERCENT
        additional_shares := math.floor(current_position_size * increase_percent / 100) * 100
        additional_shares := math.max(MIN_SHARES, additional_shares)
    else
        // è¶…è¿‡5ä¸ªç½‘æ ¼ï¼šæ ¹æ®å¸‚åœºçŠ¶æ€è°ƒæ•´åŠ ä»“æ¯”ä¾‹
        increase_percent := is_bear_market ? BEAR_MARKET_INCREASE_PERCENT : LATE_GRID_INCREASE_PERCENT
        additional_shares := math.floor(current_position_size * increase_percent / 100) * 100
        additional_shares := math.max(MIN_SHARES * 2, additional_shares)
    
    // æ£€æŸ¥èµ„é‡‘æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿåˆ™è¿”å›0
    available_cash = get_available_cash()
    if available_cash >= additional_shares * close
        additional_shares
    else
        0

// è®¡ç®—å½“å‰æ‰€æœ‰æŒä»“çš„æ€»æˆæœ¬
calculate_total_capital_used() =>
    total_cost = 0.0
    for i = 1 to current_slot
        if array.get(entry_quantities, i) > 0
            total_cost := total_cost + array.get(entry_quantities, i) * array.get(entry_prices, i)
    total_cost

// å˜é‡é‡ç½®
if strategy.position_size == 0
    current_slot := 0
    next_slot := 1

// =============== å…¥åœºå’ŒåŠ ä»“æ¡ä»¶ ===============
// æ¯æ ¹Kçº¿å‡å°‘å†·å´è®¡æ•°å™¨
if cooldown_bars > 0
    cooldown_bars := cooldown_bars - 1

// ç©ºä»“ä¸”åœ¨äº¤æ˜“æ—¶é—´å†…
entry_condition_1 = strategy.position_size == 0 and in_trading_timeframe

// å†·å´æœŸå·²è¿‡ æˆ–è€… ä»·æ ¼å›è°ƒè¶³å¤Ÿå¤§
cooldown_finished = cooldown_bars <= 0
price_dropped_enough = last_exit_price > 0 and close <= last_exit_price * (1 - REENTRY_DISCOUNT)
entry_condition_2 = cooldown_finished or price_dropped_enough

// ç»„åˆæ¡ä»¶ï¼ˆå»æ‰äº†åŸæ¥çš„ or trueï¼‰
initial_entry_condition = entry_condition_1 and entry_condition_2

// åŠ ä»“æ¡ä»¶ï¼ˆä»·æ ¼ä¸‹è·Œè‡³ä¸‹ä¸€ä¸ªç½‘æ ¼ç‚¹ä¸”æ´»è·ƒç½‘æ ¼æ•°å°äºæœ€å¤§å€¼ï¼‰
add_position_condition = strategy.position_size > 0 and in_trading_timeframe and close <= next_grid_price and current_slot > 0 and current_slot < MAX_GRIDS

// =============== æ‰§è¡Œç­–ç•¥ ===============
// åˆå§‹å»ºä»“
if initial_entry_condition
    // è®¡ç®—å¯ä»¥ä¹°å…¥çš„è‚¡æ•°ï¼ˆå‡½æ•°å†…éƒ¨å·²åŒ…å«æ¡ä»¶æ£€æŸ¥ï¼‰
    shares_to_buy = calculate_initial_shares(INITIAL_POSITION_AMOUNT, close)
    if shares_to_buy > 0
        entryId = "åˆå§‹å»ºä»“"

        strategy.entry(entryId, strategy.long, qty=shares_to_buy, comment=syminfo.ticker + " åˆå§‹å»ºä»“@" + str.tostring(close))
        
        // è®°å½•è¿™æ‰¹æ¬¡çš„ä¹°å…¥ä¿¡æ¯ï¼ˆç½‘æ ¼1å­˜å‚¨åœ¨æ•°ç»„ç´¢å¼•1ï¼‰
        array.set(entry_prices, 1, close)
        array.set(entry_quantities, 1, shares_to_buy)
        array.set(entry_ids, 1, entryId)
        
        // è®°å½•ä¹°å…¥ä»·æ ¼
        current_entry_price := close
        // æ›´æ–°ç½‘æ ¼çŠ¶æ€ï¼ˆç½‘æ ¼1å·²å ç”¨ï¼‰
        current_slot := 1
        next_slot := 2
        // è®¡ç®—ä¸‹ä¸€ä¸ªç½‘æ ¼ä»·æ ¼ï¼ˆç½‘æ ¼2ï¼‰
        next_grid_price := calculate_next_grid_price(close, current_slot)
        
        // æ›´æ–°æœ€å¤§èµ„é‡‘å ç”¨
        current_capital_used := calculate_total_capital_used()
        max_capital_used := math.max(max_capital_used, current_capital_used)
else if add_position_condition
    // è®¡ç®—åŠ ä»“æ•°é‡ï¼ˆå‡½æ•°å†…éƒ¨å·²åŒ…å«èµ„é‡‘æ£€æŸ¥ï¼‰
    additional_shares = calculate_additional_shares(strategy.position_size, current_slot)

    // ç ´äº§æ£€æµ‹ï¼šè§¦å‘åŠ ä»“æ¡ä»¶ä½†èµ„é‡‘ä¸è¶³
    if additional_shares == 0 and not is_bankrupt
        is_bankrupt := true
        bankrupt_date := k_formatted_time

    // ç½‘æ ¼åŠ ä»“
    if additional_shares > 0
        entryId = "ç½‘æ ¼åŠ ä»“#" + str.tostring(next_slot)
        strategy.entry(entryId, strategy.long, qty=additional_shares, comment = 
         syminfo.ticker + " ç½‘æ ¼åŠ ä»“#" + str.tostring(next_slot) + "@" + str.tostring(close))
        
        // è®°å½•è¿™æ‰¹æ¬¡çš„ä¹°å…¥ä¿¡æ¯ï¼ˆç½‘æ ¼ç¼–å·ç›´æ¥ä½œä¸ºæ•°ç»„ç´¢å¼•ï¼‰
        array.set(entry_prices, next_slot, close)
        array.set(entry_quantities, next_slot, additional_shares)
        array.set(entry_ids, next_slot, entryId)
        
        // æ›´æ–°æœ€åä¸€æ¬¡ä¹°å…¥ä»·æ ¼
        current_entry_price := close
        // æ›´æ–°ç½‘æ ¼çŠ¶æ€
        current_slot := next_slot
        next_slot := next_slot + 1
        // è®¡ç®—ä¸‹ä¸€ä¸ªç½‘æ ¼ä»·æ ¼
        next_grid_price := calculate_next_grid_price(close, current_slot)
        
        // æ›´æ–°æœ€å¤§èµ„é‡‘å ç”¨
        current_capital_used := calculate_total_capital_used()
        max_capital_used := math.max(max_capital_used, current_capital_used)

// å¦‚æœæœ‰æŒä»“ï¼Œåˆ¤æ–­æ˜¯å¦å¯ä»¥æ­¢ç›ˆ
if current_slot > 0
    // è·å–å½“å‰ç›‘æ§çš„æ‰¹æ¬¡ä¿¡æ¯ï¼ˆæœ€åä¸€ä¸ªæ‰¹æ¬¡ï¼Œç½‘æ ¼ç¼–å·ä¸ºcurrent_slotï¼‰
    entry_price = array.get(entry_prices, current_slot)
    entry_quantity = array.get(entry_quantities, current_slot)
    entry_id = array.get(entry_ids, current_slot)
    
    // è®¡ç®—è¯¥æ‰¹æ¬¡çš„æ­¢ç›ˆä»·æ ¼
    current_grid_profit_price := calculate_take_profit_price(entry_price, current_slot)
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ­¢ç›ˆæ¡ä»¶
    if close >= current_grid_profit_price
        c = ""
        if current_slot > 1
            c:= syminfo.ticker + " æ‰¹æ¬¡æ­¢ç›ˆ#" + str.tostring(current_slot) +"@" + str.tostring(close)
        else
            c := syminfo.ticker + " æ¸…ä»“@" + str.tostring(close)

        // è®¡ç®—æœ¬æ¬¡ç›ˆåˆ©ï¼šå–å‡ºä»· Ã— è‚¡æ•° - ä¹°å…¥ä»· Ã— è‚¡æ•°
        current_profit = entry_quantity * close - entry_quantity * entry_price
        // ç´¯åŠ åˆ°æ€»ç›ˆåˆ©
        cumulative_profit := cumulative_profit + current_profit

        // å¹³æ‰è¯¥æ‰¹æ¬¡çš„ä»“ä½
        strategy.close(entry_id, qty=entry_quantity, comment=c)
        // å‡å°‘å ç”¨çš„ç½‘æ ¼æ•°é‡
        current_slot := current_slot - 1
        next_slot := current_slot + 1

        current_capital_used := calculate_total_capital_used()

        if current_slot > 0
            // å›åˆ°ä¸Šä¸€çº§ç½‘æ ¼ä»·æ ¼
            current_entry_price := array.get(entry_prices, current_slot)
            // è®¡ç®—é¢„æœŸåŠ ä»“ä»·ï¼ˆä¸‹ä¸€ä¸ªç½‘æ ¼ä»·æ ¼ï¼‰ 
            next_grid_price := calculate_next_grid_price(current_entry_price, current_slot)
            // è®¡ç®—å–å‡ºä»·æ ¼
            current_grid_profit_price := calculate_take_profit_price(entry_price, current_slot)
        else
            cooldown_bars := COOLDOWN_PERIOD
            last_exit_price := close

// =============== ç»˜åˆ¶ä»·æ ¼çº¿ ===============
// ç»˜åˆ¶ä¸‹ä¸€ä¸ªç½‘æ ¼ä¹°å…¥ä»·
plot(strategy.position_size > 0 ? next_grid_price : na, "ä¸‹ä¸€ç½‘æ ¼ä¹°å…¥ä»·", color=color.new(color.blue, 0), style=plot.style_cross)
plot(strategy.position_size > 0 ? current_entry_price : na, "å½“å‰ç½‘æ ¼ä¹°å…¥ä»·", color=color.new(color.gray, 0), style=plot.style_cross)
plot(strategy.position_size > 0 ? current_grid_profit_price : na, "å½“å‰ç½‘æ ¼æ­¢ç›ˆä»·", color=color.new(color.red, 0), style=plot.style_cross)

// =============== ç»˜åˆ¶å‡çº¿ç³»ç»Ÿ ===============
// ç»˜åˆ¶å‡çº¿
plot(ma1, "MA100", color=color.new(#D3D3D3, 0), linewidth=1)  // æµ…ç°è‰²
plot(ma2, "MA300", color=color.new(#A9A9A9, 0), linewidth=1)  // æ·±ç°è‰²
plot(ma3, "MA500", color=color.new(#808080, 0), linewidth=1)  // ç°è‰²
plot(ma4, "MA1000", color=color.new(#696969, 0), linewidth=1) // æš—ç°è‰²

// =============== ä¿¡æ¯æ˜¾ç¤º ===============
// ç”ŸæˆDEBUGæ¨¡å¼ä¸‹çš„è¡¨æ ¼å†…å®¹
get_debug_table_content() =>
    table_content = ""
    
    if DEBUG_MODE and current_slot > 0 and barstate.islastconfirmedhistory
        // è¡¨æ ¼æ ‡é¢˜
        table_content := "Slot | ä¹°å…¥ä»· | è‚¡æ•° | é¢„æœŸå–å‡ºä»· | é¢„æœŸåŠ ä»“ä»·\n"
        table_content := table_content + "-----|--------|------|------------|------------\n"
        
        // éå†æ‰€æœ‰æ´»è·ƒçš„Slotï¼ˆç½‘æ ¼ä»1å¼€å§‹ç¼–å·ï¼‰
        for i = 1 to current_slot
            entry_price = array.get(entry_prices, i)
            entry_quantity = array.get(entry_quantities, i)
            
            if entry_quantity > 0
                grid_number = i  // ç½‘æ ¼ç¼–å·å°±æ˜¯å¾ªç¯å˜é‡i
                // è®¡ç®—é¢„æœŸå–å‡ºä»·
                expected_sell_price = calculate_take_profit_price(entry_price, grid_number)
                // è®¡ç®—é¢„æœŸåŠ ä»“ä»·ï¼ˆä¸‹ä¸€ä¸ªç½‘æ ¼ä»·æ ¼ï¼‰
                expected_add_price = calculate_next_grid_price(entry_price, grid_number)
                
                table_content := table_content + 
                     str.tostring(grid_number) + " | " + 
                     str.tostring(math.round(entry_price, 2)) + " | " + 
                     str.tostring(math.round(entry_quantity)) + " | " + 
                     str.tostring(math.round(expected_sell_price, 2)) + " | " + 
                     str.tostring(math.round(expected_add_price, 2)) + "\n"
    
    table_content

if barstate.islastconfirmedhistory
    var label info = label.new(bar_index, na, "", color=color.blue, style=label.style_label_left, textcolor=color.white)

    label.set_xy(info, bar_index, high)
    // å¸‚åœºè¶‹åŠ¿æ–‡å­—
    market_trend_text = is_bull_market ? "ğŸ‚ ç‰›å¸‚" : is_bear_market ? "ğŸ» ç†Šå¸‚" : "ğŸ“Š éœ‡è¡å¸‚"
    // ç ´äº§çŠ¶æ€æ–‡å­—
    bankrupt_text = is_bankrupt ? "âš ï¸ å·²ç ´äº§" : "âœ… æ­£å¸¸"
    // ç ´äº§æ—¥æœŸæ–‡å­—ï¼ˆä»…åœ¨ç ´äº§æ—¶æ˜¾ç¤ºï¼‰
    bankrupt_date_text = is_bankrupt ? "\nç ´äº§æ—¥æœŸï¼š" + bankrupt_date : ""

    label.set_text(info, "ç½‘æ ¼äº¤æ˜“ç­–ç•¥" + 
         "\n\nä»·å€¼ï¼š" + str.tostring(math.round(strategy.position_size * close)) + 
         "\næœ€å¤§èµ„é‡‘å ç”¨ï¼š" + str.tostring(math.round(max_capital_used)) +
         "\nå½“å‰èµ„é‡‘å ç”¨ï¼š" + str.tostring(math.round(current_capital_used)) +
         "\nç°é‡‘ä½™é¢ï¼š" + str.tostring(math.round(get_available_cash())) + 
         "\nèµ„é‡‘çŠ¶æ€ï¼š" + bankrupt_text + bankrupt_date_text +
         "\nç´¯è®¡ç›ˆåˆ©ï¼š" + str.tostring(math.round(cumulative_profit)) +
         "\næŒä»“ï¼š" + str.tostring(strategy.position_size) +
         "\nSlotï¼š" + str.tostring(current_slot) + "|" + str.tostring(math.round(strategy.position_avg_price,2)) +
         "\nå¸‚åœºè¶‹åŠ¿ï¼š" + market_trend_text )


// æ ¹æ®DEBUGæ¨¡å¼æ˜¾ç¤ºä¸åŒå†…å®¹
if DEBUG_MODE and barstate.islastconfirmedhistory
    var table debug_table = table.new(position.top_right, 5, MAX_GRIDS + 2, bgcolor=color.white, border_width=1)

    // DEBUGæ¨¡å¼ï¼šæ˜¾ç¤ºè¡¨æ ¼
    table.clear(debug_table, 0, 0, 4, MAX_GRIDS + 1)
    
    // è®¾ç½®è¡¨æ ¼æ ‡é¢˜
    table.cell(debug_table, 0, 0, "Slot", text_color=color.black, bgcolor=color.gray)
    table.cell(debug_table, 1, 0, "ä¹°å…¥ä»·", text_color=color.black, bgcolor=color.gray)
    table.cell(debug_table, 2, 0, "è‚¡æ•°", text_color=color.black, bgcolor=color.gray)
    table.cell(debug_table, 3, 0, "é¢„æœŸå–å‡ºä»·", text_color=color.black, bgcolor=color.gray)
    table.cell(debug_table, 4, 0, "é¢„æœŸåŠ ä»“ä»·", text_color=color.black, bgcolor=color.gray)
    
    // å¡«å……æ•°æ®è¡Œï¼ˆç½‘æ ¼ä»1å¼€å§‹ç¼–å·ï¼‰
    if current_slot > 0
        for i = 1 to current_slot
            entry_price = array.get(entry_prices, i)
            entry_quantity = array.get(entry_quantities, i)
            
            if entry_quantity > 0
                row = i  // è¡¨æ ¼è¡Œå· = ç½‘æ ¼ç¼–å·
                grid_number = i  // ç½‘æ ¼ç¼–å·å°±æ˜¯å¾ªç¯å˜é‡i
                expected_sell_price = calculate_take_profit_price(entry_price, grid_number)
                expected_add_price = calculate_next_grid_price(entry_price, grid_number)
                
                table.cell(debug_table, 0, row, str.tostring(grid_number), text_color=color.black)
                table.cell(debug_table, 1, row, str.tostring(math.round(entry_price, 2)), text_color=color.black)
                table.cell(debug_table, 2, row, str.tostring(math.round(entry_quantity)), text_color=color.black)
                table.cell(debug_table, 3, row, str.tostring(math.round(expected_sell_price, 2)), text_color=color.black)
                table.cell(debug_table, 4, row, str.tostring(math.round(expected_add_price, 2)), text_color=color.black)