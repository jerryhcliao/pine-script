//@version=6
// =============== ç­–ç•¥è®¾ç½® ===============
strategy("ç½‘æ ¼äº¤æ˜“ç­–ç•¥ - Aè‚¡ (æ”¹è¿›ç‰ˆ)", 
     overlay=true, 
     precision=2, 
     initial_capital=200000, 
     pyramiding=40, 
     default_qty_type = strategy.fixed,
     margin_long=100,
     margin_short=100,
     process_orders_on_close=true)

// =============== å¤šç©ºäº¤æ˜“çº¦æŸ ===============
// ä»…å…è®¸åšå¤š
strategy.risk.allow_entry_in(strategy.direction.long)

// =============== ç½‘æ ¼ç­–ç•¥å‚æ•° ===============
INITIAL_POSITION_AMOUNT = 60000.0                   // åˆå§‹å»ºä»“é‡‘é¢(å…ƒ)
EARLY_GRID_DROP_PERCENT = 0.05                      // å‰5ä¸ªç½‘æ ¼ä¸‹è·Œç™¾åˆ†æ¯”(%)
EARLY_TAKE_PROFIT_PERCENT = 0.10                    // å‰5ä¸ªç½‘æ ¼æ­¢ç›ˆç™¾åˆ†æ¯”(%)
LATE_GRID_DROP_PERCENT = 0.10                       // è¶…è¿‡5ä¸ªç½‘æ ¼åä¸‹è·Œç™¾åˆ†æ¯”(%)
LATE_TAKE_PROFIT_PERCENT = 0.15                     // è¶…è¿‡5ä¸ªç½‘æ ¼åæ­¢ç›ˆç™¾åˆ†æ¯”(%)
EARLY_GRID_INCREASE_PERCENT = 0.10                  // å‰5ä¸ªç½‘æ ¼åŠ ä»“æ¯”ä¾‹(%)
LATE_GRID_INCREASE_PERCENT = 0.15                   // è¶…è¿‡5ä¸ªç½‘æ ¼ååŠ ä»“æ¯”ä¾‹(%)
BEAR_MARKET_INCREASE_PERCENT = 0.20                 // è¶…è¿‡5ä¸ªç½‘æ ¼åï¼Œç†Šå¸‚åŠ ä»“æ¯”ä¾‹(%)
MAX_GRIDS = 40                                      // æœ€å¤§ç½‘æ ¼å±‚æ•°
COOLDOWN_PERIOD = 4                                 // æ¸…ä»“åå†·å´Kçº¿æ•°
REENTRY_DISCOUNT = 0.03                             // æå‰é‡å…¥å›è°ƒå¹…åº¦(%)
// è‚¡ç¥¨å›æµ‹æ—¶é—´é™åˆ¶ (5å¹´)
FIVE_YEARS_IN_MS = 5 * 365 * 24 * 60 * 60 * 1000

in_trading_timeframe = time > (timenow - FIVE_YEARS_IN_MS)

// --- Kçº¿æ—¶é—´ï¼Œæ–¹ä¾¿è°ƒè¯• ---
// è·å–å„ä¸ªæ—¶é—´ç»„ä»¶
yr = year(time)
mo = month(time)
dy = dayofmonth(time)
hr = hour(time)
min = minute(time)
sec = second(time)

// è½¬æ¢æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ä¸ºä¸¤ä½æ•°æ ¼å¼
mo_str = mo < 10 ? "0" + str.tostring(mo) : str.tostring(mo)
dy_str = dy < 10 ? "0" + str.tostring(dy) : str.tostring(dy)
hr_str = hr < 10 ? "0" + str.tostring(hr) : str.tostring(hr)
min_str = min < 10 ? "0" + str.tostring(min) : str.tostring(min)

// ç»„åˆæˆæœ€ç»ˆæ ¼å¼
k_formatted_time = str.tostring(yr) + mo_str + dy_str + hr_str + min_str

// =============== ç½‘æ ¼äº¤æ˜“çŠ¶æ€å˜é‡ ===============
// ç”¨æ•°ç»„è®°å½•æ¯æ‰¹æ¬¡çš„ä¹°å…¥ä»·æ ¼ã€æ•°é‡å’ŒID
var float[] entry_prices = array.new_float(MAX_GRIDS, 0.0)
var float[] entry_quantities = array.new_float(MAX_GRIDS, 0.0)
var string[] entry_ids = array.new_string(MAX_GRIDS, "")

var float available_cash = strategy.initial_capital
// è®°å½•æœ€åä¸€æ¬¡ä¹°å…¥ä»·æ ¼ï¼ˆç”¨äºè®¡ç®—ä¸‹ä¸€ä¸ªç½‘æ ¼ï¼‰
var float last_entry_price = 0.0
// è®°å½•ä¸‹ä¸€ä¸ªç½‘æ ¼ä¹°å…¥ä»·æ ¼
var float next_grid_price = 0.0
// è®°å½•å½“å‰ç½‘æ ¼æ­¢ç›ˆä»·æ ¼
var float current_grid_profit_price = 0.0
// è®°å½•å½“å‰æ´»è·ƒçš„ç½‘æ ¼
var int next_slot = 0
// æ—¶é—´å†·å´æœºåˆ¶
var int cooldown_bars = 0
// æœ€åæ¸…ä»“ä»·æ ¼
var float last_exit_price = 0.0
// æœ€å¤§èµ„é‡‘å ç”¨è®°å½•
var float max_capital_used = 0.0
// å½“å‰èµ„é‡‘å ç”¨
var float current_capital_used = 0.0

// =============== å‡çº¿ç³»ç»Ÿè®¡ç®— ===============
// è®¡ç®—4æ ¹å‡çº¿
ma1 = ta.sma(close, 25 * 4)  // æœˆçº¿
ma2 = ta.sma(close, 75 * 4)  // å­£çº¿
ma3 = ta.sma(close, 125 * 4) // åŠå¹´çº¿
ma4 = ta.sma(close, 250 * 4) // å¹´çº¿

// åˆ¤æ–­å¸‚åœºè¶‹åŠ¿
is_bull_market = ma1 > ma2 and ma2 > ma3 and ma3 > ma4
is_bear_market = ma1 < ma2 and ma2 < ma3 and ma3 < ma4

// =============== è¾…åŠ©å‡½æ•° ===============
// è®¡ç®—å¯ä»¥ä¹°å…¥çš„è‚¡æ•°ï¼ˆå¿…é¡»æ˜¯100çš„æ•´æ•°å€ï¼‰
calculate_shares(amount, price) =>
    math.floor(amount / price / 100) * 100

// è®¡ç®—ä¸‹ä¸€ä¸ªç½‘æ ¼ä¹°å…¥ç‚¹ï¼ˆæ ¹æ®å½“å‰ç½‘æ ¼å±‚æ•°ä½¿ç”¨ä¸åŒå‚æ•°ï¼‰
calculate_next_grid_price(last_price, current_slot) =>
    // å‰5ä¸ªç½‘æ ¼ä½¿ç”¨è¾ƒå°çš„ä¸‹è·Œå¹…åº¦ï¼Œè¶…è¿‡5ä¸ªç½‘æ ¼ä½¿ç”¨è¾ƒå¤§çš„ä¸‹è·Œå¹…åº¦
    drop_percent = current_slot < 5 ? EARLY_GRID_DROP_PERCENT : LATE_GRID_DROP_PERCENT
    last_price * (1 - drop_percent)

// è®¡ç®—æ­¢ç›ˆä»·æ ¼ï¼ˆæ ¹æ®å½“å‰ç½‘æ ¼å±‚æ•°ä½¿ç”¨ä¸åŒå‚æ•°ï¼‰
calculate_take_profit_price(entry_price, current_slot) =>
    // å‰5ä¸ªç½‘æ ¼ä½¿ç”¨è¾ƒå°çš„æ­¢ç›ˆå¹…åº¦ï¼Œè¶…è¿‡5ä¸ªç½‘æ ¼ä½¿ç”¨è¾ƒå¤§çš„æ­¢ç›ˆå¹…åº¦
    profit_percent = current_slot < 5 ? EARLY_TAKE_PROFIT_PERCENT : LATE_TAKE_PROFIT_PERCENT
    entry_price * (1 + profit_percent)

// è®¡ç®—åŠ ä»“æ•°é‡ï¼ˆæ ¹æ®å½“å‰ç½‘æ ¼å±‚æ•°å’Œå¸‚åœºçŠ¶æ€ä½¿ç”¨ä¸åŒåŠ ä»“ç­–ç•¥ï¼‰
calculate_additional_shares(current_position_size, current_slot) =>
    increase_percent = 0.10

    if current_slot < 5
        // å‰5ä¸ªç½‘æ ¼ï¼šä½¿ç”¨å›ºå®šåŠ ä»“æ¯”ä¾‹
        increase_percent := EARLY_GRID_INCREASE_PERCENT
        additional_shares = math.floor(current_position_size * increase_percent / 100) * 100
        min_shares = 100
        additional_shares < min_shares ? min_shares : additional_shares
    else
        // è¶…è¿‡5ä¸ªç½‘æ ¼ï¼šæ ¹æ®å¸‚åœºçŠ¶æ€è°ƒæ•´åŠ ä»“æ¯”ä¾‹
        if is_bear_market
            // ç†Šå¸‚ï¼šåŠ ä»“20%
            increase_percent := BEAR_MARKET_INCREASE_PERCENT
        else
            // éç†Šå¸‚ï¼šåŠ ä»“15%
            increase_percent := LATE_GRID_INCREASE_PERCENT
        
        additional_shares = math.floor(current_position_size * increase_percent / 100) * 100
        min_shares = 200
        additional_shares < min_shares ? min_shares : additional_shares

// è®¡ç®—å½“å‰æ‰€æœ‰æŒä»“çš„æ€»æˆæœ¬
calculate_total_capital_used() =>
    total_cost = 0.0
    for i = 0 to next_slot - 1
        if array.get(entry_quantities, i) > 0
            total_cost := total_cost + array.get(entry_quantities, i) * array.get(entry_prices, i)
    total_cost

// å˜é‡é‡ç½®
if strategy.position_size == 0
    next_slot := 0

// =============== å…¥åœºå’ŒåŠ ä»“æ¡ä»¶ ===============
// æ¯æ ¹Kçº¿å‡å°‘å†·å´è®¡æ•°å™¨
if cooldown_bars > 0
    cooldown_bars := cooldown_bars - 1

// ç©ºä»“ä¸”åœ¨äº¤æ˜“æ—¶é—´å†…
entry_condition_1 = strategy.position_size == 0 and in_trading_timeframe

// å†·å´æœŸå·²è¿‡ æˆ–è€… ä»·æ ¼å›è°ƒè¶³å¤Ÿå¤§
cooldown_finished = cooldown_bars <= 0
price_dropped_enough = last_exit_price > 0 and close <= last_exit_price * (1 - REENTRY_DISCOUNT)
entry_condition_2 = cooldown_finished or price_dropped_enough

// ç»„åˆæ¡ä»¶ï¼ˆå»æ‰äº†åŸæ¥çš„ or trueï¼‰
initial_entry_condition = entry_condition_1 and entry_condition_2

// åŠ ä»“æ¡ä»¶ï¼ˆä»·æ ¼ä¸‹è·Œè‡³ä¸‹ä¸€ä¸ªç½‘æ ¼ç‚¹ä¸”æ´»è·ƒç½‘æ ¼æ•°å°äºæœ€å¤§å€¼ï¼‰
add_position_condition = strategy.position_size > 0 and in_trading_timeframe and close <= next_grid_price and next_slot > 0 and next_slot < MAX_GRIDS

// =============== æ‰§è¡Œç­–ç•¥ ===============
// åˆå§‹å»ºä»“
if initial_entry_condition
    // è®¡ç®—å¯ä»¥ä¹°å…¥çš„è‚¡æ•°
    shares_to_buy = calculate_shares(INITIAL_POSITION_AMOUNT, close)
    // ç¡®ä¿è‡³å°‘å¯ä»¥ä¹°å…¥100è‚¡
    if shares_to_buy >= 100 and available_cash >= shares_to_buy * close  
        entryId = "åˆå§‹å»ºä»“"

        strategy.entry(entryId, strategy.long, qty=shares_to_buy, comment=syminfo.ticker + " åˆå§‹å»ºä»“@" + str.tostring(close))
        
        // è®°å½•è¿™æ‰¹æ¬¡çš„ä¹°å…¥ä¿¡æ¯
        array.set(entry_prices, 0, close)
        array.set(entry_quantities, 0, shares_to_buy)
        array.set(entry_ids, 0, entryId)
        
        // è®°å½•ç°é‡‘ä½™é¢
        available_cash := available_cash - shares_to_buy * close
        // è®°å½•ä¹°å…¥ä»·æ ¼
        last_entry_price := close
        // è®¡ç®—ä¸‹ä¸€ä¸ªç½‘æ ¼ä»·æ ¼
        next_grid_price := calculate_next_grid_price(close, next_slot)
        // é€’å¢ç½‘æ ¼
        next_slot := next_slot + 1
        
        // æ›´æ–°æœ€å¤§èµ„é‡‘å ç”¨
        current_capital_used := calculate_total_capital_used()
        max_capital_used := math.max(max_capital_used, current_capital_used)
else if add_position_condition
    // è®¡ç®—åŠ ä»“æ•°é‡ï¼ˆæ ¹æ®å½“å‰ç½‘æ ¼å±‚æ•°ä½¿ç”¨ä¸åŒåŠ ä»“æ¯”ä¾‹ï¼‰
    additional_shares = calculate_additional_shares(strategy.position_size, next_slot)

    // ç½‘æ ¼åŠ ä»“
    if available_cash >= additional_shares * close
        entryId = "ç½‘æ ¼åŠ ä»“#" + str.tostring(next_slot)
        strategy.entry(entryId, strategy.long, qty=additional_shares, comment = 
         syminfo.ticker + " ç½‘æ ¼åŠ ä»“#" + str.tostring(next_slot) + "@" + str.tostring(close))
        
        // è®°å½•è¿™æ‰¹æ¬¡çš„ä¹°å…¥ä¿¡æ¯
        array.set(entry_prices, next_slot, close)
        array.set(entry_quantities, next_slot, additional_shares)
        array.set(entry_ids, next_slot, entryId)
        
        // è®°å½•ç°é‡‘ä½™é¢
        available_cash := available_cash - additional_shares * close
        // æ›´æ–°æœ€åä¸€æ¬¡ä¹°å…¥ä»·æ ¼
        last_entry_price := close
        // è®¡ç®—ä¸‹ä¸€ä¸ªç½‘æ ¼ä»·æ ¼
        next_grid_price := calculate_next_grid_price(close, next_slot)
        // é€’å¢ç½‘æ ¼
        next_slot := next_slot + 1
        
        // æ›´æ–°æœ€å¤§èµ„é‡‘å ç”¨
        current_capital_used := calculate_total_capital_used()
        max_capital_used := math.max(max_capital_used, current_capital_used)

// å¦‚æœæœ‰æŒä»“ï¼Œåˆ¤æ–­æ˜¯å¦å¯ä»¥æ­¢ç›ˆ
if next_slot > 0
    target_slot = next_slot - 1
    // è·å–è¯¥æ‰¹æ¬¡çš„ä¿¡æ¯
    entry_price = array.get(entry_prices, target_slot)
    entry_quantity = array.get(entry_quantities, target_slot)
    entry_id = array.get(entry_ids, target_slot)
    
    // è®¡ç®—è¯¥æ‰¹æ¬¡çš„æ­¢ç›ˆä»·æ ¼
    current_grid_profit_price := calculate_take_profit_price(entry_price, target_slot)
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ­¢ç›ˆæ¡ä»¶
    if close >= current_grid_profit_price
        c = ""
        if next_slot > 1
            c:= syminfo.ticker + " æ‰¹æ¬¡æ­¢ç›ˆ#" + str.tostring(target_slot) +"@" + str.tostring(close)
        else
            c := syminfo.ticker + " æ¸…ä»“@" + str.tostring(close)

        // å¹³æ‰è¯¥æ‰¹æ¬¡çš„ä»“ä½
        strategy.close(entry_id, qty=entry_quantity, comment=c)
        // æ›´æ–°ç°é‡‘ä½™é¢
        available_cash := available_cash + entry_quantity * close
        // æ¢å¤è¯¥ç½‘æ ¼
        next_slot := next_slot - 1
        
        // å›åˆ°ä¸Šä¸€çº§ç½‘æ ¼ä»·æ ¼
        last_entry_price := close
        next_grid_price := calculate_next_grid_price(last_entry_price, next_slot)
        

        if next_slot > 0
            // å¯¹ä¹°å…¥ä»·è¿›è¡Œè°ƒæ•´ï¼Œä»¥å“åº”å®é™…å–å‡ºä»·
            array.set(entry_prices, next_slot, close)
        else
            cooldown_bars := COOLDOWN_PERIOD
            last_exit_price := close

// =============== ç»˜åˆ¶ä»·æ ¼çº¿ ===============
// ç»˜åˆ¶ä¸‹ä¸€ä¸ªç½‘æ ¼ä¹°å…¥ä»·
plot(strategy.position_size > 0 ? next_grid_price : na, "ä¸‹ä¸€ç½‘æ ¼ä¹°å…¥ä»·", color=color.new(color.blue, 0), style=plot.style_cross)
plot(strategy.position_size > 0 ? last_entry_price : na, "å½“å‰ç½‘æ ¼ä¹°å…¥ä»·", color=color.new(color.gray, 0), style=plot.style_cross)
plot(strategy.position_size > 0 ? current_grid_profit_price : na, "å½“å‰ç½‘æ ¼æ­¢ç›ˆä»·", color=color.new(color.red, 0), style=plot.style_cross)

// =============== ç»˜åˆ¶å‡çº¿ç³»ç»Ÿ ===============
// ç»˜åˆ¶å‡çº¿
plot(ma1, "MA100", color=color.new(#D3D3D3, 0), linewidth=1)  // æµ…ç°è‰²
plot(ma2, "MA300", color=color.new(#A9A9A9, 0), linewidth=1)  // æ·±ç°è‰²
plot(ma3, "MA500", color=color.new(#808080, 0), linewidth=1)  // ç°è‰²
plot(ma4, "MA1000", color=color.new(#696969, 0), linewidth=1) // æš—ç°è‰²

// =============== ä¿¡æ¯æ˜¾ç¤º ===============
var label info = label.new(bar_index, na, "", color=color.blue, style=label.style_label_left, textcolor=color.white)

label.set_xy(info, bar_index, high)
// å¸‚åœºè¶‹åŠ¿æ–‡å­—
market_trend_text = is_bull_market ? "ğŸ‚ ç‰›å¸‚" : is_bear_market ? "ğŸ» ç†Šå¸‚" : "ğŸ“Š éœ‡è¡å¸‚"

label.set_text(info, "ç½‘æ ¼äº¤æ˜“ç­–ç•¥" + 
     "\n\nä»·å€¼ï¼š" + str.tostring(math.round(strategy.position_size * close)) + 
     "\næœ€å¤§èµ„é‡‘å ç”¨ï¼š" + str.tostring(math.round(max_capital_used)) +
     "\nå½“å‰èµ„é‡‘å ç”¨ï¼š" + str.tostring(math.round(current_capital_used)) +
     "\nç°é‡‘ä½™é¢ï¼š" + str.tostring(math.round(available_cash)) + 
     "\næŒä»“ï¼š" + str.tostring(strategy.position_size) +
     "\nSlotï¼š" + str.tostring(next_slot) + "|" + str.tostring(math.round(strategy.position_avg_price,2)) +
     "\nå¸‚åœºè¶‹åŠ¿ï¼š" + market_trend_text)