//@version=6
strategy("智能定投策略: A股低频 + 美股高频", overlay=true, pyramiding=9999, default_qty_type=strategy.fixed, process_orders_on_close=true)

// 参数设置 - 统一买入金额（A股和美股相同）
AMOUNT_0 = 2000.0  // 基础金额
AMOUNT_1 = 3000.0  // 跌破1条均线
AMOUNT_2 = 4000.0  // 跌破2条均线
AMOUNT_3 = 5000.0  // 跌破3条均线
AMOUNT_4 = 6000.0  // 跌破4条均线
AMOUNT_5 = 8000.0  // 跌破5条均线

// 止盈设置
PROFIT_TARGET = 0.3

// 市场类型检测
is_us_stock = str.contains(syminfo.ticker, "159632")  // 纳指100基金归类为美股
is_a_stock = not is_us_stock  // 其他都归类为A股

// 计算EMA均线
ema200 = ta.ema(close, 200) // 双月线
ema400 = ta.ema(close, 400) // 四月线
ema600 = ta.ema(close, 600) // 半年线
ema800 = ta.ema(close, 800) // 八月线
ema1000 = ta.ema(close, 1000) // 十月线

// 在图表上绘制均线
plot(ema200, color=color.blue, title="EMA 200")
plot(ema400, color=color.green, title="EMA 400")
plot(ema600, color=color.yellow, title="EMA 600")
plot(ema800, color=color.orange, title="EMA 800")
plot(ema1000, color=color.red, title="EMA 1000")

// 追踪持仓状态
var float total_investment = 0.0
var float total_shares = 0.0
var int total_invest_time = 0
var bool dca_started = false  // 标记是否已开始定投
var float max_capital_used = 0.0  // 最大资金占用记录

// 检测是否为纳指100指数基金（159632）
is_nasdaq_fund = str.contains(syminfo.ticker, "159632")

// 检测均线空头排列：纳指100基金放宽为价格跌破所有均线，其他A股指数基金保持严格排列
is_bearish_alignment = is_nasdaq_fund ? (close < ema200 and close < ema400 and close < ema600 and close < ema800 and close < ema1000) : (ema200 < ema400 and ema400 < ema600 and ema600 < ema800 and ema800 < ema1000)

// 检测时间条件
is_monday = dayofweek == dayofweek.monday
is_first_bar_of_day = na(time_close[1]) or time_close[1] < time - 1000*60*60*6  // 如果前一根K线的时间戳与当前差超过6小时，认为是新的一天

// A股定投频率：每两周定投一次（从2020年开始的第1个周一算起）
var int a_stock_week_count = 0
if is_monday and is_first_bar_of_day and year >= 2020
    a_stock_week_count := a_stock_week_count + 1

is_a_stock_dca_day = is_monday and is_first_bar_of_day and (a_stock_week_count % 2 == 1)  // 奇数周定投

// 美股定投频率：每周一
is_us_stock_dca_day = is_monday and is_first_bar_of_day

// 检测是否在2020年之后
is_after_2020 = year >= 2020

// 如果均线转为空头排列且时间在2020年之后，开始定投
if is_bearish_alignment and not dca_started and is_after_2020
    dca_started := true

// 执行买入策略（根据市场类型使用不同频率和金额）
should_dca = (is_a_stock and is_a_stock_dca_day) or (is_us_stock and is_us_stock_dca_day)

if should_dca and dca_started
    // 根据价格位置确定买入金额
    int line_break = 0
    float investment_amount = 0.0

    if close <= ema200
        line_break := line_break + 1

    if close <= ema400
        line_break := line_break + 1

    if close <= ema600
        line_break := line_break + 1

    if close <= ema800
        line_break := line_break + 1

    if close <= ema1000
        line_break := line_break + 1

    // 根据价格位置确定买入金额（A股和美股使用相同金额）
    if line_break == 0
        investment_amount := AMOUNT_0
    else if line_break == 1
        investment_amount := AMOUNT_1
    else if line_break == 2
        investment_amount := AMOUNT_2
    else if line_break == 3
        investment_amount := AMOUNT_3
    else if line_break == 4
        investment_amount := AMOUNT_4
    else
        investment_amount := AMOUNT_5
    
    // 计算可以买入的股数，并调整为100的整数倍
    shares_to_buy = investment_amount / close
    adjusted_shares = math.floor(shares_to_buy / 100) * 100
    
    // 确保买入的股数至少为100
    if adjusted_shares >= 100 
        // 实际投入的资金
        actual_investment = adjusted_shares * close
        
        strategy.entry("定投买入", strategy.long, qty=adjusted_shares)
        
        // 更新总投入资金和持有总股数
        total_investment := total_investment + actual_investment
        total_shares := total_shares + adjusted_shares
        total_invest_time := total_invest_time + 1
        
        // 更新最大资金占用
        max_capital_used := math.max(max_capital_used, total_investment)

// 计算当前市值（仍然需要手动计算这个）
current_value = total_shares > 0 ? total_shares * close : 0

// 使用内置变量判断止盈
if strategy.openprofit / total_investment >= PROFIT_TARGET
    // 执行全部卖出操作
    strategy.close_all("目标止盈: " + str.tostring(strategy.openprofit, "#.##") + " 总投入: " +str.tostring(total_investment, "#.##"))
    
    // 重置持仓状态和定投状态
    total_investment := 0.0
    total_shares := 0.0
    total_invest_time := 0
    dca_started := false

// 在图表上显示当前持仓状态（使用中文标签）
var label status_label = na
label.delete(status_label)
status_label := label.new(bar_index, high, 
                 "定投状态: " + (dca_started ? "已开始" : "未开始") + "\n" +
                 "总投入: " + str.tostring(total_investment, "#.##") + "\n" +
                 "定投次数: " + str.tostring(total_invest_time, "#") + "\n" +
                 "持有股数: " + str.tostring(total_shares) + "\n" +
                 "当前市值: " + str.tostring(current_value, "#.##") + "\n" +
                 "收益率: " + str.tostring(total_investment > 0 ? (strategy.openprofit / total_investment) * 100 : 0, "#.##") + "% \n" +
                 "最大资金占用: " + str.tostring(max_capital_used, "#.##"),
                 style=label.style_label_left,
                 color=strategy.openprofit_percent >= 0 ? color.green : color.red)